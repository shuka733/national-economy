# コード最適化調査 プロンプト

## 目的
National Economyプロジェクトのコード品質向上のため、以下の観点で調査・改善提案を行ってください。
調査結果は各観点ごとに**問題箇所の具体的なファイル名・行番号・コード断片**を提示し、改善案をコード例付きで示してください。

## 技術スタック
- **フレームワーク**: React (TypeScript / TSX)
- **状態管理**: boardgame.io (moves / G / ctx パターン)
- **スタイル**: Vanilla CSS (`index.css`) + インラインスタイル
- **ビルド**: Vite

## 主要ファイル
- `src/Board.tsx` — メインUIコンポーネント（2500行超）
- `src/game.ts` — ゲームロジック（moves定義）
- `src/types.ts` — 型定義
- `src/index.css` — スタイルシート
- `src/bots.ts` — CPUプレイヤーロジック

---

## 調査観点

### 1. 重複ロジックの共通化 (DRY原則)
以下のパターンで重複がないか調査し、共通ヘルパー関数またはサブコンポーネントへの抽出を提案してください。

- **公共職場の描画ロジック**: 初期配置1行目・2行目、ラウンド追加、売却建物の4箇所で類似のJSX構造が繰り返されている可能性
- **枠色・ハイライト・ドラッグ属性の計算ロジック**: `data-workplace-id`, `onPointerDown/Up/Leave`, `className`のドラッグホバー判定等
- **`canPlace` 判定の重複**: `G.phase === 'work' && canInteract && canPlacePublic(...)` のようなパターン
- **プレビュー用イベントハンドラ**: `startCardPreview` / `startWorkplacePreview` + `endPreview` のセット

### 2. マジックナンバー・ハードコード値の定数化
以下の種類の値を洗い出し、名前付き定数への抽出を提案してください。

- **CSS色値のハードコード** — `rgba(45, 212, 191, 0.4)` 等のインラインスタイル → CSS変数化
- **プレビュー用カードインデックスオフセット** — `1000`, `2000`, `2100`, `2200`, `2300` 等
- **タイマー値** — `300`ms（長押し判定）等
- **レイアウト定数** — グリッド列数 `4` 等
- **スタイル定数** — opacity値（`0.45`, `0.7`）、fontSize等の繰り返し値

### 3. React コンポーネント設計
- **巨大コンポーネントの分割**: `Board.tsx` がモノリシックになっていないか。責務ごとにサブコンポーネントを抽出すべき箇所を特定
- **IIFE `{(() => { ... })()}` の多用**: サブコンポーネント抽出候補として洗い出し
- **イベントハンドラのインライン定義**: 複雑なロジックを含むインラインハンドラを関数抽出すべき箇所

### 4. 状態管理 (React Hooks)
- **`useCallback` / `useMemo` の適切性**: 不要な再計算が発生していないか
- **`useState` vs `useRef`**: 描画に関係しない値が`useState`で管理されていないか
- **`useEffect` の依存配列**: 正確性・過不足の確認
- **派生状態**: stateから計算可能な値が別stateで管理されていないか

### 5. 型安全性 (TypeScript)
- **`as` キャストの多用**: 型ガードや適切な型定義で置換できる箇所
- **`!`（non-null assertion）**: オプショナルチェーン `?.` やnullチェックで安全にできる箇所
- **インラインの型定義**: `typeof`, 無名オブジェクト型 → 名前付きtype/interfaceへの抽出候補

### 6. CSS設計
- **インラインスタイルの多用**: JSXに埋め込まれた`style={{}}`の中で繰り返されるパターン → CSSクラスへ移行
- **`!important` の使用**: 詳細度設計の見直しで不要にできないか
- **CSS変数の活用**: 既存のCSS変数（`var(--teal)`, `var(--gold)` 等）と同じ値がハードコードされている箇所

### 7. ゲームロジック分離
- **UIロジックとゲームロジックの混入**: `Board.tsx`にゲームルール判定が直接書かれている箇所 → `game.ts` や専用ユーティリティへの移動
- **ヘルパー関数の配置**: `canPlacePublic`, `canPlaceOnBuilding` 等の定義場所が適切か

### 8. パフォーマンス
- **不要な再レンダリング**: state変更による広範な再描画が発生していないか
- **`React.memo`**: サブコンポーネントで `React.memo` を適用すべき箇所
- **イベントリスナー**: document/windowレベルのリスナー登録・解除が適切か

---

## 出力フォーマット
調査結果は以下のフォーマットで出力してください：

### [観点名] の調査結果

#### 問題 1: [概要]
- **ファイル**: `ファイル名` L行番号
- **現状のコード**:
```tsx
// 問題のあるコード断片
```
- **問題点**: なぜ問題なのかの説明
- **改善案**:
```tsx
// 改善後のコード
```
- **影響範囲**: 変更による影響の説明
- **優先度**: 高/中/低

---

## 注意事項
- 機能の変更は行わず、リファクタリングのみを提案すること
- 改善案は段階的に適用可能な単位で提示すること
- 各提案には優先度（高/中/低）を付け、高優先度から順に列挙すること
- Board.tsxの分割提案時は、boardgame.ioのBoardコンポーネントパターンとの互換性に注意すること
- 日本語で回答すること
